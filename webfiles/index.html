<!--
RetroWeb Browser
Copyright (C) 2014 Marcio Teixeira

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-->
<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="resizing-layout.css">
	    <link rel="stylesheet" type="text/css" href="ui.css">
		<script type="text/javascript" src="ui.js"></script>
		<script type="text/javascript" src="utils.js"></script>
		<script type="text/javascript" src="navigator.js"></script>
		<title>RetroWeb Browser</title>
	</head>
	<body>
		<div class="main">
			<div class="background" id="background">
				<!-- Main rendering canvas for emulator: -->
				
				<div class="screen">
					<canvas id="screen" oncontextmenu="event.preventDefault()">
					</canvas>
					
					<!-- Pop-up windows that overlay the screen area: -->
					
					<div id="popup-status" class="popup">
						<div class="spinner"></div>
						<div class="emscripten" id="status">Downloading...</div>
						<div class="emscripten">
							<progress value="0" max="100" id="progress" hidden=0></progress>  
						</div>
					</div>
					
					<div id="popup-ready-to-use" class="popup">
						<img src="icons/sunny.png" class="small-icon">
						<h1>This computer needs a boot disk! Go find an icon with a green dot!</h1>
					</div>
					
					<div id="popup-rom-missing" class="popup">
						<img src="icons/rom.png" class="small-icon">
						<p>This computer cannot start without a valid ROM file.</p>
						<input type="button" value="Select ROM file..."
							onclick="openFileUploader ('Select ROM image', doRomUpload);">
					</div>
					
					<div id="popup-uploader" class="popup">
						<h1 id="uploader-text">Select a file:</h1>
						<form name="file-upload" onsubmit="return false">
							<p>
							<input type="file" id="uploaderfile" chars="80"><br>
							</p>
							<input type="submit" value="OK" id="uploader-ok-btn">
							<input type="button" value="Cancel" onclick="popups.close('popup-uploader');">
						</form>
					</div>
					
					<div id="popup-mouse-center" class="popup">
						<h1>Wait for the desktop to appear then double-click the icon.</h1>
						<img src="icons/sunny.png" id="popup-mouse-center-target" onclick="popups.close('popup-mouse-center');">
					</div>
				</div>
			</div>
				
			<br>
			<table id="ui-buttons" class="ui-buttons">
				<tr>
					<td class="ui-btn">
						<img class="btn-icon" src="icons/file-manager.png" onclick="panels.open('navigator-panel');"><br>
						<span class="btn-label">Show Navigator</span>
					</td>
					<td class="ui-btn">
						<img class="btn-icon" src="icons/power.png" onclick="restartComputer()"><br>
						<span class="btn-label">Restart Computer</span>
					</td>
				</tr>
			</table>
				
			<div class="sidepanel" id="sidepanel">
				<div id="navigator-panel" class="sidepanel-window">
					<div class="title-bar">
						<select id="platform-select" onchange="choosePlatform()">
							<option>Change computer type...</option>
							<option value="pce-macplus">Apple Macintosh (pce/macplus)</option>
							<option value="pce-atarist">Atari 1040ST (pce/atarist)</option>
							<option value="pce-ibmpc">IBM PC Model 5160 (pce/ibmpc)</option>
							<option value="pce-rc759">RC759 Piccoline(pce/rc759)</option>
						</select>
						<img class="btn-icon" src="icons/appbar.close.svg" onclick="panels.close('navigator-panel');">
						<img class="btn-icon" src="icons/appbar.arrow.left.svg" onclick="navGoBack()">
						<img class="btn-icon" src="icons/appbar.home.svg" onclick="navGoHome()">
					</div>
					<ul class="navigator" id="navigator">
					</ul>
					<p class="navigator-help">Double-click an icon to open</p>
				</div>
				
				<div id="html-viewer" class="html-viewer sidepanel-window">
					<div class="title-bar">
						<img class="btn-icon" src="icons/appbar.close.svg" onclick="panels.close('html-viewer');showHtmlViewer(false);">
					</div>
					<div class="fade-effect">
						<iframe id="html-iframe" frameborder="0" seamless="seamless" scrolling="auto" src="docs/about.html">
						</iframe>
						<div class="fade-effect-top"></div>
						<div class="fade-effect-bottom"></div>
					</div>
				</div>
			</div>
		
		</div>
		
		<script type="text/javascript">						
			var popups = new PopupManager();
			popups.add("popup-mouse-center");
			popups.add("popup-rom-missing");
			popups.add("popup-ready-to-use");
			popups.add("popup-status");
			popups.add("popup-uploader");
			
			var panels = new PopupManager();
			panels.add("navigator-panel");
			panels.add("html-viewer");
			
			panels.open("navigator-panel");
			
			function choosePlatform() {
				var platformMenu = document.getElementById('platform-select');
				var newPlatform = "platform=" + platformMenu.options[platformMenu.selectedIndex].value;
				var newPage = new String(window.location);
				if(newPage.indexOf("?") != -1) {
					newPage = newPage.replace(/platform=[a-zA-Z0-9-]+/i, newPlatform);
				} else {
					newPage = newPage + "?" + newPlatform;
				}
				window.location = newPage;
			}
		</script>
		
		<textarea class="emscripten" id="output" rows="8" hidden=1></textarea>
		
		<script type='text/javascript'>
			var statusElement = document.getElementById('status');
			var progressElement = document.getElementById('progress');
			var macStatus = document.getElementById('popup-status');

			var Module = {
				preRun: [preRun],
				postRun: [],
				preInit: [preInit],
				arguments: ["-c", "roms/pce-config.cfg", "-r"],
				noInitialRun: false,
				print: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					console.log(text);
				},
				printErr: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					console.log(text);
				},
				canvas: document.getElementById('screen'),
				setStatus: function(text) {
					  if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
					  if (text === Module.setStatus.text) return;
					  var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
					  var now = Date.now();
					  if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
					  if (m) {
						text = m[1];
						//progressElement.value = parseInt(m[2])*100;
						//progressElement.max = parseInt(m[4])*100;
						//progressElement.hidden = false;
						popups.open("popup-status");
					  } else {
						//progressElement.value = null;
						//progressElement.max = null;
						//progressElement.hidden = true;
						if (!text) popups.close("popup-status");
					  }
					  statusElement.innerHTML = text;
					},
				totalDependencies: 0,
				monitorRunDependencies: function(left) {
					this.totalDependencies = Math.max(this.totalDependencies, left);
					Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
				}
			};
			Module.setStatus('Downloading...');
		</script>

		<!-- Load the appropriate css and javascript depending on the platform -->
		
		<script type="text/javascript">
			var emuPlatform = getQueryVariable("platform");
			if (!emuPlatform) {
				emuPlatform = "pce-ibmpc";
			}
			setPlatform(emuPlatform);
			
			<!-- Load the default index into the navigator -->
			fetchNavigatorUrl();

			<!-- Load the style-sheet corresponding to the chosen platform -->
			loadResource(emuPlatform + "/ui.css");
			
			<!-- Try to load either a gzipped version of the emulator code, or a regular version -->
			loadResource(emuPlatform + "/glue.js");
			loadResource(emuPlatform + "/" + emuPlatform + ".js", true);
			<!-- loadResource(emuPlatform + "/" + emuPlatform + ".js.gz", true); -->
		</script>
		
		<!-- The following will enable Google Analytics if the .include file exists -->
		<!--#include virtual="private/googleAnalytics.include"-->
		<!-- End of Google Analytics -->
		
		<script type="text/javascript">
			if (typeof ga == 'function') {
				gaTrackEvent = function (category, action, label, value) {
					console.log("Logging event: " + category);
					ga('send', 'event', category, action, label, value);
				};
			} else {
				gaTrackEvent = function (category, action, label, value) {};
			}
		</script>
		
	</body>
</html>