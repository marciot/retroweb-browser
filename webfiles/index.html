<!--
RetroWeb Browser
Copyright (C) 2014 Marcio Teixeira

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-->
<html>
	<head>
	    <link rel="stylesheet" type="text/css" href="ui.css">
		<script type="text/javascript" src="ui.js"></script>
		<script type="text/javascript" src="utils.js"></script>
		<script type="text/javascript" src="navigator.js"></script>
		<title>RetroWeb Browser</title>
	</head>
	<body>
		<div id="main">
				<div id="background">
				</div>
				
				<div id="screen-area">

					<!-- Main rendering canvas for emulator: -->
					
					<canvas class="emscripten" id="screen" oncontextmenu="event.preventDefault()">
					</canvas>
					
					<!-- Pop-up windows that overlay the screen area: -->
					
					<div id="popup-status" class="popup">
						<div class="spinner"></div>
						<div class="emscripten" id="status">Downloading...</div>
						<div class="emscripten">
							<progress value="0" max="100" id="progress" hidden=0></progress>  
						</div>
					</div>
					
					<div id="popup-ready-to-use" class="popup">
						<img src="icons/sunny.png" class="small-icon">
						<h1>This computer needs a boot disk! Go find an icon with a green dot!</h1>
					</div>
					
					<div id="popup-rom-missing" class="popup">
						<img src="icons/rom.png" class="small-icon">
						<p>This computer cannot start without a valid ROM file.</p>
						<input type="button" value="Select ROM file..."
							onclick="openFileUploader ('Select ROM image', doRomUpload);">
					</div>
					
					<div id="popup-uploader" class="popup">
						<h1 id="uploader-text">Select a file:</h1>
						<form name="file-upload" onsubmit="return false">
							<p>
							<input type="file" id="uploaderfile" chars="80"><br>
							</p>
							<input type="submit" value="OK" id="uploader-ok-btn">
							<input type="button" value="Cancel" onclick="popups.close('popup-uploader');">
						</form>
					</div>
				</div>
								
				<script type="text/javascript">						
					var popups = new PopupManager();
					popups.add("popup-rom-missing");
					popups.add("popup-ready-to-use");
					popups.add("popup-status");
					popups.add("popup-uploader");
					
					function choosePlatform() {
						var platformMenu = document.getElementById('platform-select');
						var newPlatform = "platform=" + platformMenu.options[platformMenu.selectedIndex].value;
						var newPage = new String(window.location);
						if(newPage.indexOf("?") != -1) {
							newPage = newPage.replace(/platform=[a-zA-Z-]+/i, newPlatform);
						} else {
							newPage = newPage + "?" + newPlatform;
						}
						window.location = newPage;
					}
				</script>
				
				<div id="sidepanel">
						<div id="platform">
							<table style="width:90%;">
								<tr>
									<td>
										<select id="platform-select" onchange="choosePlatform()">
											<option>Change computer type...</option>
											<option value="pce-macplus">Apple Macintosh (pce/macplus)</option>
											<option value="pce-ibmpc">IBM Personal Computer (pce/ibmpc)</option>
										</select>
									</td>
									<td class="nav-btn">
										<img class="btn-icon" src="icons/back.png" onclick="navGoBack()"><br>
										<span class="btn-label">Go Back</span>
									</td>
									<td class="nav-btn">
										<img class="btn-icon" src="icons/home.png" onclick="navGoHome()"><br>
										<span class="btn-label">Go Home</span>
									</td>
									<td class="nav-btn">
										<img class="btn-icon" src="icons/power.png" onclick="emulatorReset()"><br>
										<span class="btn-label">Restart Computer</span>
									</td>
								</tr>
							</table>
						</div>
						<p>
						<div id="navigator">
						</div>
						<div id="html-viewer-button">
							<input type="button" value="Close" onClick="htmlViewerCloseAction();">
						</div>
						<div id="html-viewer">
							<iframe id="html-iframe" frameborder="0" seamless="seamless" scrolling="auto" src="docs/about.html">
							</iframe>
							<div id="html-text-viewer"></div>
							<!--<div class="fade-effect-top"></div>-->
							<div class="fade-effect-bottom"></div>
						</div>
				</div>
		</div>
		
		
		<textarea class="emscripten" id="output" rows="8" hidden=1></textarea>

		<script type="text/javascript">
			fetchNavigatorUrl();
		</script>
		
		<script type='text/javascript'>
			var statusElement = document.getElementById('status');
			var progressElement = document.getElementById('progress');
			var macStatus = document.getElementById('popup-status');

			var Module = {
				preRun: [preRun],
				postRun: [],
				preInit: [preInit],
				arguments: ["-c", "roms/pce-config.cfg", "-g", "cga", "-r"],
				noInitialRun: false,
				print: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					console.log(text);
				},
				printErr: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					console.log(text);
				},
				canvas: document.getElementById('screen'),
				setStatus: function(text) {
					  if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
					  if (text === Module.setStatus.text) return;
					  var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
					  var now = Date.now();
					  if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
					  if (m) {
						text = m[1];
						//progressElement.value = parseInt(m[2])*100;
						//progressElement.max = parseInt(m[4])*100;
						//progressElement.hidden = false;
						popups.open("popup-status");
					  } else {
						//progressElement.value = null;
						//progressElement.max = null;
						//progressElement.hidden = true;
						if (!text) popups.close("popup-status");
					  }
					  statusElement.innerHTML = text;
					},
				totalDependencies: 0,
				monitorRunDependencies: function(left) {
					this.totalDependencies = Math.max(this.totalDependencies, left);
					Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
				}
			};
			Module.setStatus('Downloading...');
		</script>

		<!-- Load the appropriate css and javascript depending on the platform -->
		
		<script type="text/javascript">
			var emuPlatform = getQueryVariable("platform");
			if (!emuPlatform) {
				emuPlatform = "pce-ibmpc";
			}
			
			setPlatform(emuPlatform);
			
			<!-- Load the style-sheet corresponding to the chosen platform -->
			loadResource(emuPlatform + "/ui.css");
			
			<!-- Try to load either a gzipped version of the emulator code, or a regular version -->
			loadResource(emuPlatform + "/glue.js");
			loadResource(emuPlatform + "/" + emuPlatform + ".js", true);
			<!-- loadResource(emuPlatform + "/" + emuPlatform + ".js.gz", true); -->
		</script>
		
		<!-- Google Analytics (change this to your own site! )-->
		
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-47856782-1', 'freeshell.org');
		  ga('send', 'pageview');
		</script>
		
		<!-- End of Google Analytics -->
		
	</body>
</html>